// ZeroUpload v1.0 - http://github.com/jhuckaby/zeroupload - MIT Licensed
var ZeroUpload={url:"",maxFiles:0,maxBytes:0,acceptTypes:"",inited:false,hooks:{start:null,progress:null,complete:null,error:function(e,t){alert("ZeroUpload Error: "+t)}},setURL:function(e){this.url=e},setMaxFiles:function(e){this.maxFiles=parseInt(e,10);if(this.fileElem){if(this.maxFiles!=1)this.fileElem.attr("multiple","multiple");else this.fileElem.removeAttr("multiple")}},setMaxBytes:function(e){this.maxBytes=parseInt(e,10)},setFileTypes:function(){this.acceptTypes=Array.prototype.slice.call(arguments,0).join(",");if(this.fileElem){if(this.acceptTypes)this.fileElem.attr("accept",this.acceptTypes);else this.fileElem.removeAttr("accept")}},init:function(){if(this.inited)return;this.inited=true;if(!window.jQuery)throw"ZeroUpload cannot initialize, because jQuery is not loaded.";this.setupFileElem()},setupFileElem:function(){if(this.fileElem){this.fileElem.remove()}this.fileElem=jQuery('<input type="file" '+(this.maxFiles!=1?'multiple="multiple"':"")+(this.acceptTypes?'accept="'+this.acceptTypes+'"':"")+' style="display:none"/>').appendTo("body").bind("change",function(){if(this.files&&this.files.length){ZeroUpload.upload(this.files,ZeroUpload.clickUrlParams,ZeroUpload.clickUserData)}})},addDropTarget:function(e,t,r){if(!e)e=document;if(!t)t=null;if(!r)r=null;jQuery(e).unbind("dragenter").bind("dragenter",function(e){jQuery(this).addClass("dragover");e.preventDefault();e.stopPropagation();return false}).unbind("dragover").bind("dragover",function(e){jQuery(this).addClass("dragover");e.preventDefault();e.stopPropagation();return false}).unbind("dragleave").bind("dragleave",function(e){jQuery(this).removeClass("dragover");e.preventDefault();e.stopPropagation();return false}).unbind("drop").bind("drop",function(e){jQuery(this).removeClass("dragover");if(e.originalEvent.dataTransfer.files.length){e.preventDefault();e.stopPropagation();ZeroUpload.upload(e.originalEvent.dataTransfer.files,t,r);return false}})},removeDropTarget:function(e){jQuery(e).unbind("dragenter").unbind("dragover").unbind("dragleave").unbind("drop")},chooseFiles:function(e,t){if(!e)e=null;if(!t)t=null;this.clickUrlParams=e;this.clickUserData=t;this.fileElem[0].click()},upload:function(e,t,r){if(this.inProgress)return;if(!this.url)return;if(!window.FormData)return this.dispatch("error","unsupported","Your browser is unsupported.",r);var i=e.length;if(this.maxFiles&&e.length>this.maxFiles){return this.dispatch("error","maxfiles","Too many files were selected. Please only select "+this.maxFiles+".")}if(this.maxBytes){var a=0;for(var s=0;s<i;s++){if(typeof e[s].size=="number")a+=e[s].size}if(a>this.maxBytes){return this.dispatch("error","maxbytes","File size too large: "+a+" bytes")}}if(this.acceptTypes){var o=new RegExp("^("+this.acceptTypes.replace(/\*/g,".+").replace(/\//g,"\\/").split(/\,\s*/).join("|")+")$");for(var s=0;s<i;s++){if(!e[s].type.match(o)){return this.dispatch("error","filetype","File type not accepted: "+e[s].name+" ("+e[s].type+")")}}}var n=new XMLHttpRequest;this.inProgress=true;if(n.upload&&n.upload.addEventListener){n.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=ZeroUpload.getUploadProgress(e);ZeroUpload.dispatch("progress",t,r)}},false)}var l=new FormData;for(var s=0;s<i;s++){l.append("file"+Math.floor(s+1),e[s])}if(jQuery.isPlainObject(r)){for(var p in r){l.append(p,""+r[p])}}n.onreadystatechange=function(){if(n.readyState==4){var e={code:n.status,data:n.responseText,statusLine:n.statusText,xhr:n};ZeroUpload.inProgress=false;if(e.code>=200&&e.code<400){ZeroUpload.dispatch("complete",e,r)}else{if(e.code){ZeroUpload.dispatch("error","http","Error uploading files: HTTP "+e.code+" "+e.statusLine)}else{ZeroUpload.dispatch("error","ajax","Error uploading files: Internal Error",r)}}}};var u=this.dispatch("start",e,r);if(false===u){this.inProgress=false;return false}var d=""+this.url;if(t){if(typeof t=="string"){d=t}else if(jQuery.isPlainObject(t)){for(var p in t){d+=(d.match(/\?/)?"&":"?")+p+"="+encodeURIComponent(t[p])}}}this.timeStart=this.timeNow();try{n.open("POST",d,true);n.send(l)}catch(f){this.inProgress=false;this.dispatch("error","ajax","Error uploading files: "+f.toString(),r)}this.setupFileElem()},on:function(e,t){e=e.replace(/^on/i,"").toLowerCase();if(typeof this.hooks[e]=="undefined")throw"Event type not supported: "+e;this.hooks[e]=t},dispatch:function(){var e=arguments[0].replace(/^on/i,"").toLowerCase();var t=Array.prototype.slice.call(arguments,1);if(this.hooks[e]){if(typeof this.hooks[e]=="function"){return this.hooks[e].apply(this,t)}else if(typeof this.hooks[e]=="array"){return this.hooks[e][0][this.hooks[e][1]].apply(this.hooks[e][0],t)}else if(window[this.hooks[e]]){return window[this.hooks[e]].apply(window,t)}else{throw"Event listener not a function: "+e}}return true},timeNow:function(){var e=new Date;return e.getTime()/1e3},getTextFromBytes:function(e){e=parseInt(e,10);if(e>=1024){e=parseInt(e/1024*10,10)/10;if(e>=1024){e=parseInt(e/1024*10,10)/10;if(e>=1024){e=parseInt(e/1024*10,10)/10;return e+" GB"}else return e+" MB"}else return e+" K"}else return e+" bytes"},getTextFromSeconds:function(e,t){var r="";e=parseInt(e,10);if(e<0){e=-e;r="-"}var i="second";var a=e;if(t){var s=a%t;if(s)a=a-s+t}if(e>59){var o=parseInt(e/60,10);e=e%60;i="minute";a=o;if(o>59){var n=parseInt(o/60,10);o=o%60;i="hour";a=n;if(n>23){var l=parseInt(n/24,10);n=n%24;i="day";a=l;if(l>29){var p=parseInt(l/30,10);l=l%30;i="month";a=p}}}}var u=a+" "+i;if(a!=1)u+="s";return r+u},getUploadProgress:function(e){var t=this.timeNow();var r=t-this.timeStart;var i=e.loaded/e.total;var a=r>0?e.loaded/r:0;var s=-1;var o="";if(i>0){s=parseInt((1-i)*r/i,10);o=this.getTextFromSeconds(s,10)}return{elapsedRaw:r,elapsedHuman:this.getTextFromSeconds(r),amount:i,percent:""+Math.floor(i*100)+"%",dataSentRaw:e.loaded,dataSentHuman:this.getTextFromBytes(e.loaded),dataTotalRaw:e.total,dataTotalHuman:this.getTextFromBytes(e.total),dataRateRaw:a,dataRateHuman:this.getTextFromBytes(a)+"/sec",remainingTimeRaw:s,remainingTimeHuman:o,originalEvent:e}}};